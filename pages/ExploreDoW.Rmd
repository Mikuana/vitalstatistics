---
title: "Day of Week Exploration"
author: "Christopher Boyd"
output:
  tufte::tufte_html: default
bibliography: skeleton.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  include=TRUE
)
```

```{r libraries, include=FALSE}
library(tufte)
library(vitalstatistics)
library(ggplot2)
library(dplyr)
library(lubridate)
library(tufte)
```


[Directory](index)

# Summary

This document shows that births tend to occur much more frequently on weekdays, and in the middle of the week in particular. This effect was less prevalent in the 70's, but has become more pronounced in recent years.

# Analysis

```{r data-prep}
b.dow = births  # using a shorthand name for modified data set
```

One of the attributes that we have a nearly complete record for is day of the week. We'll start our analysis by comparing the distribution of live births throughout the week using the complete data set. A check for completeness of the data show that of the `r scales::comma(b.dow %>% summarize(sum(cases)))` records of live birth in our data set, we have `r scales::comma(b.dow %>% filter(is.na(birth_weekday_date)) %>% summarize(sum(cases)))` missing values for the `birth_weekday_date` that are missing data for day of week. We'll look at a breakdown of years where these values are missing (using the `birth_month_date`, which should be 100% complete).

```{r dow-check}
b.dow %>%  
    group_by(birth_year = year(birth_month_date)) %>%
    summarize(
        misses = sum(ifelse(is.na(birth_weekday_date), cases, 0)),
        cases = sum(cases),
        rate = misses / cases,
        rate_format = scales::percent(round(rate, digits=5))
    ) %>%
    filter(misses > 0) %>%
    mutate_at(vars(cases, misses), scales::comma) %>%
    select(
        `Birth Year` = birth_year,
        `Live Births` = cases,
        `Records Missing Day of Week` = misses,
        `Percent Missing` = rate_format
    ) %>%
    knitr::kable(., format="markdown", align = "r")
```

We can see that 1968 is completely lacking day of week data, which is expected since birth records from that year included neither day of month or day of week data. However, after 1968 there is less than 1/10th of a percent of records missing from any year, with the worst years being 1969 and 1970, and missing data halting entirely after 1984. Overall, this is very complete data if we note that 1968 is missing in its entirety.

## Exploration

```{r dow-prep}
b.dow = b.dow %>%
    filter(!is.na(birth_weekday_date)) %>%  # remove missing records
    ext_birth_weekday %>%
    ext_birth_year %>% 
    ext_birth_decade %>%
    # label 60's as 1969 since that is the only year that's included for this analysis
    mutate(birth_decade = recode(birth_decade, '1960s' = '1969')) %>%
    group_by(birth_weekday)  # add a default grouping for weekday for convenience
```

Our exploration of this attribute is primarily interested in the distribution of births the week. Our assumption here is that there should be no _biological_ reason why births favor any particular weekday `r margin_note('Those who have worked with date calculations and data in date form understand that calendards do no correspond well to the regular schedules maintained by human beings.')`. We graph this distribution as a percentage, with a line at 14.3% (i.e. `1/7`), which is where the weekly share of births would fall for each day if there was no bias toward any particular day. 

```{r}
dow.plot = function(dat) {  # create ggplot function for multiple use
    ggplot(dat, aes(birth_weekday, weekly_share, label=scales::percent(weekly_share))) +
        geom_hline(yintercept = 1/7, col="red") +  # draw a line at 14.3%
        geom_bar(stat="identity", alpha=0.80) +
        geom_label() +
        scale_y_continuous(labels=scales::percent) +
        coord_cartesian(ylim=c(0.07, 0.18)) +
        xlab("Birth Day of Week") +
        ylab("Distribution of Births in Week (%)")
}

b.dow %>%
    summarise(live_births = sum(cases)) %>%
    mutate(weekly_share = live_births / sum(live_births)) %>%
    dow.plot(.) + geom_label(aes(1, 1/7, label=scales::percent(1/7)))
```

However, the graph reveals that births are not evenly distributed, with births much more heavily weighted towards weekdays than weekends. Sunday in particular falls well below the 14.3% non-bias level. To dive a little deeper into this question while still remaining at the "exploratory" level of analysis, we look at how this distribution has changed over time. We will recast this graphic with a facet for each weekday, track the decade on the y-axis, and plot our outcomes as a line instead of a bar. This will allow us to much more easily discern how frequently births occur on certain days over time. Again, we include a red line to indicate the point which each day would fall if there were no bias towards particular days of the week for birth.

```{r}
b.dow.decades = b.dow %>%
    group_by(birth_decade, add=TRUE) %>%
    summarise(live_births = sum(cases)) %>%
    group_by(birth_decade) %>%  # group again on summarized data for denominator calculation
    mutate(weekly_share = live_births / sum(live_births))

b.dow.decades %>%
    ggplot(aes(birth_decade, weekly_share, group=birth_weekday)) + 
        facet_grid(. ~ birth_weekday) +
        geom_hline(yintercept = 1/7, col="red") +
        geom_line(stat='identity') +
        scale_y_continuous(labels=scales::percent)+
        coord_cartesian(ylim=c(0.07, 0.18)) +
        theme(axis.text.x=element_text(angle=90, size=8)) +
        xlab("Decade of Birth") +
        ylab("Distribution of Births in Week (%)")
```

With this final graphic, it becomes extremely clear that (1) births are much more heavily biased towards weekdays, (2) births are biased towards the middle of the week in particular, and (3) this trend has become more extreme over time. 

But what does this mean in plain language? We'll propose a theoretical week in which 7000 births occur. If there was no bias on which day they were born and births occurred completely randomly, then ~1000 births would occur on each day. However, as of the 2010s, the week would probably look like this:

```{r}
b.dow.decades %>%
    filter(birth_decade == '2010s') %>%
    mutate(est = round(weekly_share / (1/7) * 1000, 0)) %>%
    group_by %>%  # drop decades grouping
    select(
        Weekday = birth_weekday,
        `Estimated Births` = est
    ) %>%
    knitr::kable(., format="markdown", align = "r")
```

[Directory](index)
