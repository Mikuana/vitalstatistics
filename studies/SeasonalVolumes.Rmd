---
title: "Seasonal Birth Volumes"
output: 
    html_document:
        keep_md: true
---
[Back to Document Directory](README.md)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE}
library(vitalstatistics)
library(dplyr)
library(data.table)
library(lubridate)
library(ggplot2)
```

# Summary
There are many patterns that will appear in any data set, and all of them could potentially signal a relationship with an important factor. Others are more obviously the artifacts process or measurement. However in both cases we need to identify and define these patterns so that the irrelevant ones can be accounted for and excluded (i.e. silence the noise), and the interesting ones can be investigated.

## Monthly Calendar Adjustments
```{r load}
births %>% str
```
We start by loading the standard births data set, and then examining the volume of births that occur on a monthly basis. Month is the most granular level of date that we are likely to work with since the recent birth certificate data published by the CDC does not get any more granular (all though some old years do include the day of the month).

```{r}
births %>% group_by(month_date) %>%
    summarize(cases = sum(cases)) %>%
    ggplot(aes(month_date, cases)) +
        geom_line(stat="identity") +
        geom_smooth()
```

In general we see an increase in the overall volume of births occuring in the US, with a flattening of the overall pattern in the 90's and 00's. The reader may also notice an annually recurring pattern, with one broad spike occuring in each year. This can be made more clear by overplotting each year of data that we have on a month-by-month basis as a percentage of births for the entire year that occured in each month.

```{r}
mlab = data.table(month_key = seq(ymd(19010101), ymd(19011231), by="months")) %>%
    mutate(
        mid = month(month_key),
        mdays = days_in_month(month_key),
        ypos = (mdays - 28) * 0.001 + 0.075
    )

births_monthly = births %>% 
    group_by(DOB_YY, DOB_MM, month_date) %>%
    summarize(cases = sum(cases)) %>%
    group_by(DOB_YY) %>%
    mutate(
        annual_cases = sum(cases),
        annual_share = cases / annual_cases,
        leap_month = ifelse(leap_year(DOB_YY) & DOB_MM == 'February', annual_share, NA)
    )

births_monthly%>%
    ggplot(aes(DOB_MM, annual_share, group=DOB_YY)) +
        coord_cartesian(ylim=c(0.0725, 0.0925)) +
        ggtitle("Monthly Distribution of Births") +
        xlab("Month of Birth") + 
        theme(axis.text.x = element_text(angle=45, hjust=1)) +
        ylab("Share of Annual Births") + 
        scale_y_continuous(labels=scales::percent) +
        geom_line(aes(color=DOB_YY), alpha=0.5) + 
            scale_color_continuous(name="Birth Year") +
        geom_point(aes(y=leap_month, shape="Leap Month"), na.rm=TRUE) + 
            scale_shape_discrete(name=NULL) +
        geom_text(data=mlab, aes(x=mid, y=ypos, group=NULL, label=mdays), color="red", vjust=3) +
        annotate("text", x=4, y=0.09, label="text denotes number of days in a month", color="red")
```

There is an artifact (i.e. noise) caused by the way that the Julian calendar works which is made clear in this graphic. The To help illustrate the point, we've plotted the number of days in each month in red (we show February as 28 although there are some years with 29 days, which have been denoted). This allows us to very easily see that the proportional number of births in each month vary according to the number of days. This makes a great deal of sense; months are not equal interval units, and there is little reason to believe that the population would somehow coordinate an equal distribution of birth across each month. The theory that this pattern is a result of the varying number of days in a month - rather than th result of a different confounding factor which operates on alternating months - is supported by the fact that the dip in proportional rates are less or even reversed in July and Auguest where two 31 days months are back to back, as well as by the more severe dip in February, which is somewhat muted during leap years.

Clearly, in order to identify other patterns in our data that might be driven by factors related to time, we first need to control for the effect of the varying number of days in each month. Our solution is to weight the count of births so that each month is treated as if it's an equal interval. This is accomplished by calculating the share of days in that month (e.g. `30/365`) for the year, as a proportion of months in the year (e.g.`(1/12) / (30/365)`).

We have commited this function as part of this package

```{r}
cmaw
```
An now we apply that weight to our volumes.

```{r}
p = births_monthly %>%
    ggplot(aes(DOB_MM, annual_share * cmaw(month_date), group=DOB_YY)) + 
        coord_cartesian(ylim=c(0.0725, 0.0925)) +
        ggtitle("Weighted Monthly Distribution of Births") +
        ylab("Share of Annual Births") + 
        scale_y_continuous(labels=scales::percent) +
        xlab("Month of Birth") + theme(axis.text.x = element_text(angle=45, hjust=1))

p + geom_line(aes(color=DOB_YY), alpha=0.5) + scale_color_continuous(name="Birth Year")
```

We can see that the monthly oscillations are much more smooth, and that we've successfully muted some of the noise in our data.

## Seasonal Trends
After removing the oscillations caused by varying length months, it's clear that there's still a strong pattern related to date. There's an increasing share of births that occur from January onward, until the peak in August, which drops dramatically until January of the next year. We can help the eye somewhat with the overplotting of all these different years by using boxplots.

```{r}
p + geom_boxplot(aes(group=DOB_MM)) +
    geom_hline(yintercept = 1/12, size=0.10, linetype=2)
```

In addition to the boxplots we include a horizontal line at `r scales::percent(1/12)`, which shows us where the mean of each boxplot should lie if there were no differences in the share of births that occur in each month after adjusting for calendar artifacts. 

We can use some of the time-series tools included with R to decompose the data and attempt to isolate the seasonal pattern.

```{r}
seas = births_monthly %>% group_by %>%
    transmute(cases = cases * cmaw(month_date)) %>%
    ts(frequency=12, start=1968) %>%
    decompose(type="multiplicative")

plot(seas)
```

Which provides us with a seasonal adjustment factor that we can apply as another weight in addition to `cmaw`.

```{r}
births %>% 
    mutate(cases_seas_adj = (cases * cmaw(month_date)) / seas$figure[DOB_MM]) %>%
    group_by(month_date) %>%
    summarize(cases_seas_adj = sum(cases_seas_adj)) %>%
    ggplot(aes(month_date, cases_seas_adj)) +
        geom_line(stat="identity") +
        geom_smooth()
```
